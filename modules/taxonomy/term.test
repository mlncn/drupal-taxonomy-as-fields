<?php
// $Id$

class TermFieldTestCase extends TaxonomyWebTestCase {
  protected $instance;

  public static function getInfo() {
    return array(
      'name'  => t('Term Field'),
      'description'  => t("Test the creation of term fields."),
      'group' => t('Field')
    );
  }

  function setUp() {
    parent::setUp('field_test');
    drupal_install_modules(array('term'), TRUE);

    $web_user = $this->drupalCreateUser(array('access field_test content', 'administer field_test content'));
    $this->drupalLogin($web_user);
    $this->vocabulary = $this->createVocabulary();
  }

  // Test fields.

  /**
   * Test term field validation.
   */
  function testTermFieldValidation() {
    // Create a field with settings to validate.
    try {
      $max_length = 3;
    } catch (Exception $e) {
    }
    $this->field = array(
      'field_name' => drupal_strtolower($this->randomName()),
      'type' => 'term',
      'module' => 'term',
      'settings' => array(
        'vid' => $this->vocabulary->vid,
      )
    );
    field_create_field($this->field);
    $this->instance = array(
      'field_name' => $this->field['field_name'],
      'bundle' => FIELD_TEST_BUNDLE,
      'widget' => array(
        'type' => 'options_select',
      ),
      'display' => array(
        'full' => array(
          'type' => 'term_default',
        ),
      ),
    );
    field_create_instance($this->instance);
    // Test valid and invalid values with field_attach_validate().
    $entity = field_test_create_stub_entity(0, 0, FIELD_TEST_BUNDLE);
    $term = $this->createTerm($this->vocabulary);
    $entity->{$this->field['field_name']}[0]['value'] = $term->tid;
    try {
      field_attach_validate('test_entity', $entity);
      $this->assertText($term->name, "Term $term->name is usable as a field value in a bundle.");
    }
    catch (FieldValidationException $e) {
      $this->assertText($term->name, "Term $term->name isn't usable as a field value in a bundle.");
    }
  }

  /**
   * Test widgets.
   */
  function testTermFieldWidgets() {
    $this->_testTermFieldWidgets('term', 'term_default');
    $this->_testTermFieldWidgets('term', 'term_plain');
  }

  /**
   * Helper function for testTermfieldWidgets().
   */
  function _testTermFieldWidgets($field_type, $widget_type) {
    // Setup a field and instance
    $entity_type = 'test_entity';
    $this->field_name = drupal_strtolower($this->randomName());
    $this->field = array('field_name' => $this->field_name, 'type' => $field_type, 'module' => 'term');
    field_create_field($this->field);
    $this->instance = array(
      'field_name' => $this->field_name,
      'bundle' => FIELD_TEST_BUNDLE,
      'label' => $this->randomName() . '_label',
      'widget' => array(
        'type' => $widget_type,
      )
    );
    field_create_instance($this->instance);

    // Display creation form.
    $this->drupalGet('test-entity/add/test-bundle');
    $this->assertFieldByName($this->field_name . '[0][value]', '', t('Widget is displayed'));

    // Submit with some value.
    $value = $this->randomName();
    $edit = array(
      $this->field_name . '[0][value]' => $value,
    );
    $this->drupalPost(NULL, $edit, t('Save'));
    preg_match('|test-entity/(\d+)/edit|', $this->url, $match);
    $id = $match[1];
    $this->assertRaw(t('test_entity @id has been created.', array('@id' => $id)), t('Entity was created'));

    // Display the object.
    $entity = field_test_entity_load($id);
    $entity->content = field_attach_view($entity_type, $entity);
    $this->content = drupal_render($entity->content);
    $this->assertText($value, 'Filtered tags are not displayed');
  }

  /**
   *
   */
}

